name: Deploy Test

on:
  push:
    branches:
      - staging

  workflow_dispatch:
    inputs:
      environment:
        description: "Environment"
        required: true
        default: "dev"
        type: choice
        options:
          - "dev"
          - "stg"
          - "prd"

jobs:
  check-user:
    runs-on: ubuntu-latest
    # workflow_dispatch (æ‰‹å‹•å®Ÿè¡Œ) ã®å ´åˆã®ã¿ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒã‚§ãƒƒã‚¯ã‚’å®Ÿè¡Œ
    if: ${{ github.event_name == 'workflow_dispatch' }}
    steps:
      - name: Check allowed users
        run: |
          # è¨±å¯ã™ã‚‹ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ãƒªã‚¹ãƒˆï¼ˆGitHubãƒ¦ãƒ¼ã‚¶ãƒ¼åï¼‰
          ALLOWED_USERS=("user2" "user3")
          ACTOR="${{ github.actor }}"

          echo "ğŸ‘¤ Workflow triggered by: ${ACTOR}"
          echo "ğŸ“‹ Allowed users: ${ALLOWED_USERS[@]}"

          # ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒè¨±å¯ãƒªã‚¹ãƒˆã«å«ã¾ã‚Œã¦ã„ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
          if [[ " ${ALLOWED_USERS[@]} " =~ " ${ACTOR} " ]]; then
            echo "âœ… User '${ACTOR}' is authorized to run this workflow"
          else
            echo "âŒ Error: User '${ACTOR}' is not authorized to run this workflow"
            echo "Please contact the repository administrator if you need access."
            exit 1
          fi

  deploy:
    runs-on: ubuntu-latest
    # check-user ã‚¸ãƒ§ãƒ–ãŒæˆåŠŸã—ãŸå ´åˆã€ã¾ãŸã¯pushã‚¤ãƒ™ãƒ³ãƒˆã®å ´åˆã®ã¿å®Ÿè¡Œ
    needs: [check-user]
    if: ${{ always() && (needs.check-user.result == 'success' || needs.check-user.result == 'skipped') }}
    # ã“ã® environment è¨­å®šãŒé‡è¦ï¼GitHub Environmentsã®ä¿è­·ãƒ«ãƒ¼ãƒ«ã‚’æœ‰åŠ¹åŒ–
    environment: ${{ github.event.inputs.environment || 'stg' }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Show deployment info
        run: |
          echo "ğŸš€ Deploying to: ${{ github.event.inputs.environment || 'stg' }}"
          echo "ğŸ“¦ Branch: ${{ github.ref_name }}"
          echo "ğŸ‘¤ Triggered by: ${{ github.actor }}"
          echo "â° Timestamp: $(date)"

      - name: Simulate deployment
        run: |
          echo "Starting deployment..."
          sleep 5
          echo "Deployment completed successfully!"

      - name: Post-deployment info
        run: |
          echo "âœ… Deployment to ${{ github.event.inputs.environment || 'stg' }} finished"
